

<!DOCTYPE html>
<html class="writer-html5" lang="zh" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>任务计划设置 &mdash; AutoDataProcessDocs 1.0.0 文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="数据源JSON格式设置" href="jsonsetting.html" />
    <link rel="prev" title="数据中心设置" href="dbsetting.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> AutoDataProcessDocs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">调度平台</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../scheduler-start/index.html">启动项目</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">任务搭建及插件开发</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="datasourcesetting.html">数据源设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="dbsetting.html">数据中心设置</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">任务计划设置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">新增任务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">修改任务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">插件内使用配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">插件开发</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">插件扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">插件配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">插件更新</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">插件调试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="jsonsetting.html">数据源JSON格式设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="systemprofile.html">系统参数</a></li>
<li class="toctree-l2"><a class="reference internal" href="systemvariables.html">系统变量</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasklog.html">任务日志</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler-Instructions/index.html">搭建一个任务示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler-deploy/index.html">安装部署</a></li>
</ul>
<p class="caption"><span class="caption-text">API平台</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api-start/index.html">启动项目</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-setting/index.html">接口搭建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-Instructions/index.html">使用说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-deploy/index.html">安装部署</a></li>
</ul>
<p class="caption"><span class="caption-text">ETL工具</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../etl-start/index.html">简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../etl-start/index.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../etl-start/index.html">使用说明</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AutoDataProcessDocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">调度任务设置</a> &raquo;</li>
        
      <li>任务计划设置</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/scheduler-tasksetting/tasksetting.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>任务计划设置<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>在 <a class="reference internal" href="datasourcesetting.html"><span class="doc">维护好数据源后</span></a> 和 <a class="reference internal" href="dbsetting.html"><span class="doc">维护好数据中心</span></a> 后，需要新增调度任务</p>
<div class="section" id="id2">
<h2>新增任务<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<img alt="../_images/addtask.png" src="../_images/addtask.png" />
<img alt="../_images/addtaskinfo.png" src="../_images/addtaskinfo.png" />
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">任务编号</span></code>：必填，保持唯一即可</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">任务名称</span></code>：必填，符合任务的含义即可</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">任务类型</span></code>：必填，目前支持 常用调度和中间件调度（ <code class="docutils literal notranslate"><span class="pre">RabbitMQ</span></code> 、 <code class="docutils literal notranslate"><span class="pre">Kafka</span></code> ）两种形式，如果不是针对中间件传输数据的调度，选择通用即可</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">数据中心选择</span></code>：必填，选择任务在哪个 <code class="docutils literal notranslate"><span class="pre">数据中心</span></code> 下查询 <strong>数据源设置</strong> 中的数据源（ <code class="docutils literal notranslate"><span class="pre">空数据源</span></code> 类型，此处设置无效）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MQ上传地址</span></code>：选填，<code class="docutils literal notranslate"><span class="pre">任务类型</span></code> 选择 <code class="docutils literal notranslate"><span class="pre">RabbitMQ</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">Kafka</span></code> 配置好的地址（该地址在 <strong>消息中间件设置</strong> 页面可修改）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">添加数据源</span></code>：非必填，该任务调度执行的数据源，可以多选，多选的数据源每次调度都会按顺序循环处理</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">开始时间</span></code>：选填，调度的开始时间</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">结束时间</span></code>：选填，调度的结束时间</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">调度周期</span></code>：选填，分为 <strong>小时、日、周、月</strong> ，小时指的每天every day，日指得是每天几点执行一次，周指的是指定每周几执行一次，月指的是每月的几号执行一次</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">程序集</span></code>：选填，对应任务的程序集，编译出来的 <cite>动态链接库</cite> dll名称，如：<code class="docutils literal notranslate"><span class="pre">RomensCloudETLScheduler.dll</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IJOB实现类</span></code>：选填，插件对应的“入口”， <cite>命名空间+类名</cite> ,如： <code class="docutils literal notranslate"><span class="pre">RomensCloudETLScheduler.ETLSingleTableJob</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">配置文件</span></code>：非必填，如果未在程序目录下的 <code class="docutils literal notranslate"><span class="pre">Configs</span></code> 文件夹下配置 <code class="docutils literal notranslate"><span class="pre">json</span></code> 配置文件，则手动填写后缀名为json的文件会自动在创建在 <code class="docutils literal notranslate"><span class="pre">Configs</span></code> 文件夹下，详情查看 <strong>任务对应的配置文件</strong> 章节</p></li>
</ul>
</div>
<div class="section" id="id3">
<h2>修改任务<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<img alt="../_images/edittaskinfo.png" src="../_images/edittaskinfo.png" />
<img alt="../_images/edittaskjson.png" src="../_images/edittaskjson.png" />
<p>修改任务时，可以对 <code class="docutils literal notranslate"><span class="pre">配置文件</span></code> 进行编辑，注意在json编辑器种编辑如果前面出现红色的 × ，需要去 <a class="reference external" href="http://www.bejson.com/">验证</a> json的有效性，确保json文件内的格式没有问题</p>
<p>修改完 <code class="docutils literal notranslate"><span class="pre">配置文件</span></code> 后，如果该任务处在已启动状态，需要重新启动任务后，新的配置文件才能生效</p>
</div>
<div class="section" id="id5">
<h2>插件内使用配置文件<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>配置文件格式默认为 <code class="docutils literal notranslate"><span class="pre">json格式的文件</span></code> ，只要满足json文件的格式，就可以在插件中获取到任务对应配置文件的信息</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">JobDemo</span>
<span class="p">{</span>
  <span class="c1">//单表数据源的插件</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Job</span> <span class="p">:</span> <span class="n">IMyJob</span>
  <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">LogHelper</span> <span class="n">_logHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LogHelper</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">ExecuteJob</span><span class="p">(</span><span class="n">JobPara</span> <span class="n">jobpara</span><span class="p">,</span> <span class="n">DataSet</span> <span class="n">ds</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">_logHelper</span><span class="p">.</span><span class="n">Debug</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}&quot;</span><span class="p">);</span>
      <span class="k">try</span>
      <span class="p">{</span>
          <span class="c1">//第一种方法：获取任务对应的json配置文件内的键值</span>
          <span class="kt">string</span> <span class="n">address</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">ConfigurationInfo</span><span class="p">[</span><span class="s">&quot;WMSApiAddress:888&quot;</span><span class="p">];</span>

          <span class="c1">//第二种方法：直接绑定到结构一样的实体类</span>
          <span class="n">DbNumberInfos</span> <span class="n">dbNumberInfos</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DbNumberInfos</span><span class="p">();</span>
          <span class="n">jobpara</span><span class="p">.</span><span class="n">ConfigurationInfo</span><span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">dbNumberInfos</span><span class="p">);</span>


          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">true</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">_logHelper</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}执行失败，失败信息{ex.Message}&quot;</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">false</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如上述代码所示， <code class="docutils literal notranslate"><span class="pre">jobpara.ConfigurationInfo[&quot;WMSApiAddress:888&quot;]</span></code> ，能够取到配置文件内对应的值 <a class="reference external" href="http://localhost:7005">http://localhost:7005</a>，取数据的方式可以参考 <a class="reference external" href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/configuration/?view=aspnetcore-3.1">netcore3.1获取配置</a> .</p>
</div>
<div class="section" id="id6">
<h2>插件开发<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>创建 <code class="docutils literal notranslate"><span class="pre">.Net</span> <span class="pre">Core</span> <span class="pre">3.1</span></code> 类库，添加如下引用：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AdminWeb.Core.Common</span></code> ：提供了公共方法（比如：加密、http请求、文件处理等）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AdminWeb.Core.DbHelper</span></code> ：提供了数据库访问的帮助类</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AdminWeb.Core.Model</span></code>：提供了部分Model模型</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AdminWeb.Core.TaskJob</span></code> ：任务作业（含打印日志、任务接口等）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Microsoft.Extensions.Configuration.Abstractions</span></code> ：该组件抽象了.NET Core的配置功能,并对自定义扩展制定了新的标准</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Microsoft.Extensions.Configuration.Binder</span></code> ：可以使用选项模式将文件配置绑定到相关实体类</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Newtonsoft.Json</span></code> ：.Net中开源的Json序列化和反序列化工具</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>后期会创建插件的 <strong>NuGet</strong> 模板，通过命令一次性生成 <code class="docutils literal notranslate"><span class="pre">.Net</span> <span class="pre">Core</span> <span class="pre">3.1</span></code> 类库项目</p>
</div>
<p>插件开发分为 <code class="docutils literal notranslate"><span class="pre">单表插件开发</span></code> 和 <code class="docutils literal notranslate"><span class="pre">多表插件插件</span></code> 开发，两种插件的IJOB类实现的接口不同，<strong>单表</strong> 和 <strong>空数据源</strong> 插件需要实现 <code class="docutils literal notranslate"><span class="pre">IMyJob</span></code> 接口，<strong>多表</strong> 需要实现 <code class="docutils literal notranslate"><span class="pre">IMyMultiJob</span></code> 接口，如下图：</p>
<p>单表数据源的插件：</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nn">JobDemo</span>
<span class="p">{</span>
  <span class="c1">//单表数据源和空数据源的插件</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Job</span> <span class="p">:</span> <span class="n">IMyJob</span>
  <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">LogHelper</span> <span class="n">_logHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LogHelper</span><span class="p">();</span><span class="c1">//日志组件</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">ExecuteJob</span><span class="p">(</span><span class="n">JobPara</span> <span class="n">jobpara</span><span class="p">,</span> <span class="n">DataSet</span> <span class="n">ds</span><span class="p">)</span>
    <span class="p">{</span>

      <span class="n">_logHelper</span><span class="p">.</span><span class="n">Debug</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}&quot;</span><span class="p">);</span>
      <span class="n">DataTable</span> <span class="n">dt</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">Tables</span><span class="p">[</span><span class="s">&quot;Head&quot;</span><span class="p">];</span><span class="c1">//查出来的数据</span>
      <span class="k">try</span>
      <span class="p">{</span>
          <span class="kt">string</span> <span class="n">taskId</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">JobId</span><span class="p">;</span><span class="c1">//任务计划的编码</span>
          <span class="kt">string</span> <span class="n">taskName</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">JobName</span><span class="p">;</span><span class="c1">//任务计划的名称</span>
          <span class="kt">string</span> <span class="n">dataSourceId</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">JobDetailId</span><span class="p">;</span><span class="c1">//数据源的编码</span>
          <span class="kt">string</span> <span class="n">dataSourceName</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">JobDetailName</span><span class="p">;</span><span class="c1">//数据源的编码</span>
          <span class="n">List</span><span class="p">&lt;</span><span class="n">t_SystemProfile</span><span class="p">&gt;</span> <span class="n">systemProfiles</span><span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">SpEntity</span><span class="p">;</span><span class="c1">//调度平台的系统参数模块</span>
          <span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">ConfigurationInfo</span><span class="p">;</span><span class="c1">//任务对应的json配置文件信息</span>
          <span class="kt">var</span> <span class="n">mqModel</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">MQModel</span><span class="p">;</span><span class="c1">//任务对应的消息中间件的地址</span>
          <span class="cp">#region RabbitMQ的信息</span>
          <span class="kt">string</span> <span class="n">exchangeName</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">ExchangeName</span><span class="p">;</span><span class="c1">//数据源设置中的RabbitMQ的交换机</span>
          <span class="kt">string</span> <span class="n">queueName</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">QueueName</span><span class="p">;</span><span class="c1">//数据源设置中的RabbitMQ的队列</span>
          <span class="kt">string</span> <span class="n">routingKey</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">RoutingKey</span><span class="p">;</span><span class="c1">//数据源设置中的RabbitMQ的路由</span>
          <span class="kt">var</span> <span class="n">mqType</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">MQType</span><span class="p">;</span><span class="c1">//数据源设置中的RabbitMQ的类型</span>
          <span class="cp">#endregion</span>
          <span class="cp">#region Kafka</span>
          <span class="kt">string</span> <span class="n">topic</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">Topic</span><span class="p">;</span><span class="c1">//数据源设置中的Kafka对应的主题</span>
          <span class="kt">string</span> <span class="n">partitions</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">Partitions</span><span class="p">;</span><span class="c1">//数据源设置中的Kafka配置的分区信息</span>
          <span class="cp">#endregion</span>
          <span class="kt">var</span> <span class="n">orgSetting</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">OrgEntity</span><span class="p">;</span><span class="c1">//任务对应的数据库的地址</span>
          <span class="kt">var</span> <span class="n">dbConns</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">DBConns</span><span class="p">;</span><span class="c1">//数据中心配置多数据库时，对应的数据库和地址的字典</span>
          <span class="kt">var</span> <span class="n">dataSourceConn</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">Conn</span><span class="p">;</span><span class="c1">//任务对应的默认数据库连接字符串</span>
          <span class="kt">var</span> <span class="n">dbType</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">DataBaseType</span><span class="p">;</span><span class="c1">//MySql:0 SqlServer:1 Oracle:3</span>
          <span class="kt">var</span> <span class="n">taskPlanGroupId</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">TaskPlanGuid</span><span class="p">;</span><span class="c1">//调度的任务分组分组ID</span>
          <span class="kt">var</span> <span class="n">isDebugLog</span><span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">IsDebugLog</span><span class="p">;</span><span class="c1">//无需手动配置，该参数在调度平台的系统参数模块维护，使用 LogHelper 组件打印，内部已判断</span>
          <span class="kt">var</span> <span class="n">dllName</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">DllName</span><span class="p">;</span><span class="c1">//任务对应的程序集的动态链接库名称</span>
          <span class="kt">var</span> <span class="n">className</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">ClassName</span><span class="p">;</span><span class="c1">//任务对应的IJob实现类</span>
          <span class="kt">var</span> <span class="n">connString</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">ConnString</span><span class="p">;</span><span class="c1">//任务对应数据源的连接字符串（数据源设置的新增、修改界面可以修改最下面的连接字符串（选填））</span>
          <span class="kt">var</span> <span class="n">isPlugExecSql</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">IsPlugExecSql</span><span class="p">;</span><span class="c1">//对于单表和多表数据源，想要插件内判断和执行成功、失败语句，去调度平台的系统参数模块维护即可</span>
          <span class="kt">var</span> <span class="n">successSql</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">SuccessSqlString</span><span class="p">;</span><span class="c1">//数据源设置的成功后执行语句</span>
          <span class="kt">var</span> <span class="n">failSql</span> <span class="p">=</span> <span class="n">jobpara</span><span class="p">.</span><span class="n">FailSqlString</span><span class="p">;</span><span class="c1">//数据源设置的失败后执行语句</span>
          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">true</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">_logHelper</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}执行失败，失败信息{ex.Message}&quot;</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">false</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>多表数据源的插件：</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nn">JobDemo</span>
<span class="p">{</span>
  <span class="c1">//IJobExtension 多表数据源的插件</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Job</span> <span class="p">:</span> <span class="n">IMyMultiJob</span>
  <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">LogHelper</span> <span class="n">_logHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LogHelper</span><span class="p">();</span><span class="c1">//日志组件</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">ExecuteJob</span><span class="p">(</span><span class="n">JobPara</span> <span class="n">jobpara</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DataSet</span><span class="p">&gt;</span> <span class="n">dss</span><span class="p">)</span>
    <span class="p">{</span>

      <span class="n">_logHelper</span><span class="p">.</span><span class="n">Debug</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}&quot;</span><span class="p">);</span>
      <span class="k">try</span>
      <span class="p">{</span>
          <span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="n">dss</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span><span class="c1">//主表数据源查出来的数据条数</span>
          <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">ds</span> <span class="k">in</span> <span class="n">dss</span><span class="p">)</span>
          <span class="p">{</span>
              <span class="n">DataTable</span> <span class="n">dt</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">Tables</span><span class="p">[</span><span class="s">&quot;Head&quot;</span><span class="p">];</span><span class="c1">//主表数据源查出来的数据(默认一条数据)</span>
              <span class="n">DataTable</span> <span class="n">detailDt1</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">Tables</span><span class="p">[</span><span class="s">&quot;Detail1&quot;</span><span class="p">];</span><span class="c1">//明细数据源1</span>
              <span class="n">DataTable</span> <span class="n">detailDt2</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">Tables</span><span class="p">[</span><span class="s">&quot;Detail2&quot;</span><span class="p">];</span><span class="c1">//明细数据源2</span>
              <span class="n">DataTable</span> <span class="n">detailDt3</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">Tables</span><span class="p">[</span><span class="s">&quot;Detail3&quot;</span><span class="p">];</span><span class="c1">//明细数据源3</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">true</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">_logHelper</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}执行失败，失败信息{ex.Message}&quot;</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">false</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>插件扩展<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>插件扩展接口 <code class="docutils literal notranslate"><span class="pre">IJobExtension</span></code> 接口，该接口的作用是点击 <strong>任务计划设置</strong> 的 <code class="docutils literal notranslate"><span class="pre">启动</span></code> 和 <code class="docutils literal notranslate"><span class="pre">停止</span></code> 按钮时触发</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nn">JobDemo</span>
<span class="p">{</span>
  <span class="c1">//IJobExtension 扩展插件</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Job</span> <span class="p">:</span> <span class="n">IMyJob</span><span class="p">,</span> <span class="n">IJobExtension</span>
  <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">LogHelper</span> <span class="n">_logHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LogHelper</span><span class="p">();</span><span class="c1">//日志组件</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 任务启动时执行</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;jobDataMaps&quot;&gt;含任务绑定的配置文件信息和任务基本信息&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">StartEvent</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">jobDataMaps</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//任务第一次点击启动时执行</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">ExecuteJob</span><span class="p">(</span><span class="n">JobPara</span> <span class="n">jobpara</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DataSet</span><span class="p">&gt;</span> <span class="n">dss</span><span class="p">)</span>
    <span class="p">{</span>

      <span class="n">_logHelper</span><span class="p">.</span><span class="n">Debug</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}&quot;</span><span class="p">);</span>
      <span class="k">try</span>
      <span class="p">{</span>
          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">true</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">_logHelper</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="n">jobpara</span><span class="p">,</span> <span class="s">&quot;调用主任务：{jobpara.JobId}.{jobpara.JobName}，子任务：{jobpara.JobDetailId}.{jobpara.JobDetailName}执行失败，失败信息{ex.Message}&quot;</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="k">false</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 任务停止时执行</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;jobDataMaps&quot;&gt;含任务绑定的配置文件信息和任务基本信息&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">StopEvent</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">jobDataMaps</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//任务第一次点击停止时执行</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h2>插件配置<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>将编译出来的插件DLL，放置程序的 <code class="docutils literal notranslate"><span class="pre">Handlers</span></code> 文件夹下</p></li>
</ul>
<img alt="../_images/plugin.png" src="../_images/plugin.png" />
<ul class="simple">
<li><p>任务计划设置，修改 <code class="docutils literal notranslate"><span class="pre">程序集</span></code> 和 <code class="docutils literal notranslate"><span class="pre">IJob实现类</span></code> 信息项</p></li>
</ul>
<img alt="../_images/pluginsetting.png" src="../_images/pluginsetting.png" />
<ul class="simple">
<li><p>最后保存即可</p></li>
</ul>
<img alt="../_images/taskplanlist.png" src="../_images/taskplanlist.png" />
</div>
<div class="section" id="id9">
<h2>插件更新<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<p>由于 <code class="docutils literal notranslate"><span class="pre">netcore3.1</span></code> 的 <strong>热加载</strong> 能力，插件在任务启动时，就已经加载完毕，不需要每次调度都调用该插件，所以不需要重启服务，直接覆盖重启对应任务即可，插件更新的步骤如下：</p>
<ul class="simple">
<li><p>将修改后编译的DLL，覆盖到 <code class="docutils literal notranslate"><span class="pre">Handlers</span></code> 文件夹下</p></li>
<li><p>重新 <code class="docutils literal notranslate"><span class="pre">停止</span></code> 再 <code class="docutils literal notranslate"><span class="pre">启动</span></code> 即可（注意：不要 <code class="docutils literal notranslate"><span class="pre">暂停</span></code> ，必须停止再重启，新插件才会起到修改后的作用，否则执行的插件逻辑还是修改前的插件逻辑）</p></li>
</ul>
</div>
<div class="section" id="id10">
<h2>插件调试<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<p>双击 <strong>AdminWeb.Core.exe</strong> ，本地启动程序，确保插件在 <code class="docutils literal notranslate"><span class="pre">Debug</span></code> 可调试状态下，并且 <code class="docutils literal notranslate"><span class="pre">Handlers</span></code> 文件夹下的插件补丁是 <strong>当前代码最新编译出来的DLL文件</strong> ，添加到进程，再启动任务等待执行即可</p>
<ul class="simple">
<li><p>编译文件，覆盖到 <code class="docutils literal notranslate"><span class="pre">Handlers</span></code> 文件夹下</p></li>
<li><p>双击 <strong>AdminWeb.Core.exe</strong> ，本地启动程序</p></li>
<li><p>插件程序在 <code class="docutils literal notranslate"><span class="pre">Debug</span></code> 可调试状态下，附加到 <strong>AdminWeb.Core.exe</strong> 进程</p></li>
<li><p>启动需要调试的任务计划，等待执行即可</p></li>
</ul>
<img alt="../_images/plugindebug.png" src="../_images/plugindebug.png" />
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="jsonsetting.html" class="btn btn-neutral float-right" title="数据源JSON格式设置" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dbsetting.html" class="btn btn-neutral float-left" title="数据中心设置" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2021, ysj.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>